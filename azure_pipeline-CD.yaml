name: Fineract_$(Date:yyyyMMdd)$(Rev:.r)
trigger: none

resources:
  pipelines:
   - pipeline: fineractBuild
     source: fineract-CI
     trigger:
      branches:
       include:
         - master
         - develop
         - pull/*
         - refs/pull/*

pool:
  vmImage: ubuntu-latest

variables:
  AzureSubscription: 'Azure Service Connection'
  ClusterResourceGroup: MSF-AKS-Nao-Produtivo-RG
  AksClusterName: msf-aks
  HelmVersion: 3.5.0
  ApiName: 'core'
  ChartPackage: '$(Pipeline.Workspace)/fineractBuild/$(ApiName)/fineract-$(resources.pipeline.fineractBuild.runname).tgz' 
  ReleaseValuesFile: '$(Pipeline.Workspace)/fineractBuild/$(ApiName)/values.release.yaml' 
  ResourceGroupLocation: northcentralus

stages:
- stage: Dev     
  # condition: startsWith(variables['resources.pipeline.fineractBuild.sourcebranch'], 'refs/heads/master')
  variables:
    DeploymentEnvironment: 'dev'
    K8sNamespace: '$(ApiName)-$(DeploymentEnvironment)'
    URL: $(DeploymentEnvironment).$(SubDomain).$(DnsZoneName)
  jobs:
  - deployment: Web_Dev
    displayName: 'Deploy fineract to the fineract-dev environment'
    environment: fineract-dev
    strategy:
      runOnce:
        deploy:
          steps:
          - download: fineractBuild
            artifact: $(ApiName)

          - template: templates/SetDnsRecords.yml
            parameters:
              azureSubscription: '$(AzureSubscription)'
              clusterResourceGroup: '$(ClusterResourceGroup)'
              kubernetesCluster: $(AksClusterName)
              resourceGroupLocation: $(ResourceGroupLocation)
              dnsZoneName: $(DnsZoneName)
              resourceGroupNameDNS: $(ResourceGroupNameDNS)

          - template: templates/DeployHelmPackage.yml
            parameters:
              azureSubscription: '$(AzureSubscription)'
              clusterResourceGroup: '$(ClusterResourceGroup)'
              kubernetesCluster: $(AksClusterName)
              helmVersion: $(HelmVersion)
              k8sNamespace: $(K8sNamespace)
              chartPackage: '$(ChartPackage)'              
              releaseValuesFile: '$(ReleaseValuesFile)' 
              apiName: $(ApiName)
              